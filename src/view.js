import { el } from "date-fns/locale";

const h1El = document.querySelector("h1");
const breadcrumbNav = document.querySelectorAll(".breadcrumb-nav");
const sortButtonsContainer = document.querySelector(".sort-buttons-container");
const itemContainer = document.querySelector(".item-container");
const lowerButtonsContainer = document.querySelector(".lower-buttons-container"); // prettier-ignore

const setTheme = function (theme) {
  document.documentElement.className = theme;
  localStorage.setItem("odin-todo-list-theme", theme);
};

const loadTheme = function () {
  if (localStorage.getItem("theme") !== null) {
    setTheme(localStorage.getItem("odin-todo-list-theme"));
  } else {
    setTheme("theme-1");
  }
};

const toggleTheme = function () {
  h1El.addEventListener("click", function () {
    document.documentElement.className === "theme-1"
      ? setTheme("theme-2")
      : setTheme("theme-1");
  });
};

const renderBreadcrumbNav = function (view, currentProject) {
  if (view === "projects") {
    breadcrumbNav.forEach((element) => (element.innerHTML = ``));
    breadcrumbNav.forEach(
      (element) =>
        (element.innerHTML = `
  <span class="all-projects">All Projects</span>
  <span class="separator">></span>
  `)
    );
  }

  if (view === "tasks") {
    breadcrumbNav.forEach((element) => (element.innerHTML = ``));
    breadcrumbNav.forEach(
      (element) =>
        (element.innerHTML = `
  <button class="btn-view-all-projects">All Projects</button>
  <span class="separator">></span>
  <span class="current-project">${currentProject.title}</span>
  `)
    );
  }
};

const renderProjectViewButtons = function () {
  lowerButtonsContainer.innerHTML = `
  <button class="btn-new-item">+</button>
  `;
};

const clearProjectViewButtons = function () {
  sortButtonsContainer.innerHTML = "";
  lowerButtonsContainer.innerHTML = "";
};

const renderTaskViewButtons = function () {
  sortButtonsContainer.innerHTML = `
  <button class="btn-sort-due-date">Due Date</button>
  <button class="btn-sort-priority">Priority</button>
  `;

  lowerButtonsContainer.innerHTML = `
  <button class="btn-back-to-all-projects">&lt</button>
  <button class="btn-new-item">+</button>
  `;
};

const clearTaskViewButtons = function () {
  sortButtonsContainer.innerHTML = "";
  lowerButtonsContainer.innerHTML = "";
};

const clearItemContainer = function () {
  itemContainer.innerHTML = "";
};

const renderProjectCard = function (project) {
  const renderProjectDetails = function (project) {
    let taskCount = 0;
    project.tasks.forEach((task) => {
      if (task.status === "pending") taskCount += 1;
    });
    return `${taskCount} pending task${taskCount > 1 ? "s" : ""}`;
  };

  const projectCard = document.createElement("div");
  projectCard.className = "project-card";
  projectCard.dataset.projectId = project.id;
  projectCard.innerHTML = `
  <div class="project-header">
    <div class="project-header-left">
      <input class="input-project-title" value="${
        project.title
      }" maxlength="28"/>
    </div>
    <div class="project-header-right">
      <button class="btn-project-move-down">ᐯ</button>
      <button class="btn-project-move-up">ᐱ</button>
      <button class="btn-project-delete">X</button>
    </div>
  </div>
  <div class="project-details">
    <div>
      ${renderProjectDetails(project)}
    </div>
  </div>
  `;

  return projectCard;
};

// prettier-ignore
const renderTaskCard = function (task) {
  const taskCard = document.createElement("div");
  taskCard.className = "task-card";
  taskCard.dataset.taskId = task.id;
  taskCard.classList.add(`${task.status}`);
  taskCard.classList.add(`${task.priority}`);
  taskCard.innerHTML = `
    <div class="task-header ${task.status}">
      <div class="task-header-left">
        <button class="btn-task-status ${task.status}"></button>
        <input class="input-task-title ${task.status}" value="${task.title}" ${task.inputStatus}/>
      </div>
      <div class="task-header-right">
        <button class="btn-task-delete">X</button>
      </div>
    </div>
    <div class="task-details ${task.status}">
      <textarea class="input-task-description ${task.status}" name="task-description" ${task.inputStatus}>${task.description}</textarea>
      <div class="task-bottom-row">
        <input type="date" class="input-task-due-date" value="${task.dueDate}" ${task.inputStatus}/>
        <div class="task-days-remaining">${task.getDaysRemaining()}</div>
        <button class="btn-task-priority" ${task.inputStatus}>
          <span class="priority-label">${task.priority}</span>
          <span class="priority-indicator ${task.priority}"></span>
        </button>
      </div>
    </div>
  `;

  return taskCard;
};

const renderAllProjects = function (projects) {
  for (let [key, value] of Object.entries(projects)) {
    itemContainer.prepend(renderProjectCard(value));
  }
};

const sortTasksByDueDate = function (targetProjectTasks) {
  const tasks = [...targetProjectTasks];
  let isSorted = false;
  while (!isSorted) {
    isSorted = true;
    for (let i = 0; i < tasks.length - 1; i++) {
      const date1 = new Date(tasks[i].dueDate);
      const date2 = new Date(tasks[i + 1].dueDate);
      if (date1 > date2) {
        let temp = tasks[i + 1];
        tasks[i + 1] = tasks[i];
        tasks[i] = temp;
        isSorted = false;
      }
    }
  }
  return tasks;
};

// prettier-ignore
const sortTasksByPriority = function (targetProjectTasks) {
  const tasksHighPriority = targetProjectTasks.filter((task) => task.priority === "high");
  const tasksMediumPriority = targetProjectTasks.filter((task) => task.priority === "medium");
  const tasksLowPriority = targetProjectTasks.filter((task) => task.priority === "low");

  const tasks = [...tasksHighPriority, ...tasksMediumPriority, ...tasksLowPriority];
  return tasks;
};

// prettier-ignore
const renderTasks = function (targetProjectTasks, sortCriteria) {
  if (sortCriteria === "dueDate") {
    const tasksByPriority = sortTasksByPriority(targetProjectTasks);
    const tasksByDueDate = sortTasksByDueDate(tasksByPriority);
    tasksByDueDate.forEach((task) => itemContainer.append(renderTaskCard(task)));
  } else if (sortCriteria === "priority") {
    const tasksByDueDate = sortTasksByDueDate(targetProjectTasks);
    const tasksByPriority = sortTasksByPriority(tasksByDueDate);
    tasksByPriority.forEach((task) => itemContainer.append(renderTaskCard(task)));
  } else {
    for (let [key, value] of Object.entries(targetProjectTasks)) {
      itemContainer.prepend(renderTaskCard(value));
    }
  }
};

const showTaskViewButtons = function (targetProject) {
  if (targetProject.tasks.length < 2) {
    const btnSortByDueDate = document.querySelector(".btn-sort-due-date");
    const btnSortByPriority = document.querySelector(".btn-sort-priority");

    if (btnSortByDueDate) btnSortByDueDate.classList.add("hidden");
    if (btnSortByPriority) btnSortByPriority.classList.add("hidden");
  }
};

const showTopOfPage = function () {
  window.scrollTo(0, 0);
};

const autoAdjustHeight = function (taskDescriptionEl) {
  // Adjust height upon rendering or expansion of the task card
  taskDescriptionEl.style.height = "";
  taskDescriptionEl.style.height = taskDescriptionEl.scrollHeight + "px";

  // Adjust height to accomodate additional lines of text as required
  taskDescriptionEl.addEventListener("input", () => {
    taskDescriptionEl.style.height = "";
    taskDescriptionEl.style.height = taskDescriptionEl.scrollHeight + "px";
  });
};

const toggleTaskDetails = function (taskCard) {
  const taskDetailsEl = taskCard.querySelector(".task-details");
  taskDetailsEl.classList.toggle("visible");
};

const toggleTaskElements = function (button) {
  button.classList.toggle("completed");
  button.classList.toggle("pending");

  const taskCardEl = button.parentElement.parentElement.parentElement;
  const taskHeaderEl = taskCardEl.querySelector(".task-header");
  const taskTitleInputEl = taskCardEl.querySelector(".input-task-title");
  const taskDetailsEl = taskCardEl.querySelector(".task-details");
  const taskDescriptionEl = taskCardEl.querySelector(".input-task-description");
  const taskDueDateEl = taskCardEl.querySelector(".input-task-due-date");
  const taskPriorityEl = taskCardEl.querySelector(".btn-task-priority");

  taskCardEl.classList.toggle("completed");
  taskCardEl.classList.toggle("pending");
  taskHeaderEl.classList.toggle("completed");
  taskHeaderEl.classList.toggle("pending");
  taskTitleInputEl.classList.toggle("completed");
  taskTitleInputEl.classList.toggle("pending");
  taskDetailsEl.classList.toggle("completed");
  taskDetailsEl.classList.toggle("pending");
  taskDescriptionEl.classList.toggle("completed");
  taskDescriptionEl.classList.toggle("pending");

  taskDetailsEl.classList.remove("visible");

  taskTitleInputEl.disabled = !taskTitleInputEl.disabled;
  taskDescriptionEl.disabled = !taskDescriptionEl.disabled;
  taskDueDateEl.disabled = !taskDueDateEl.disabled;
  taskPriorityEl.disabled = !taskPriorityEl.disabled;
};

// prettier-ignore
const clickHandlerCompletedTaskCard = function () {
  const completedTaskCardNL = document.querySelectorAll(".task-card");
  completedTaskCardNL.forEach((taskCard) => {
    taskCard.addEventListener("click", () => {
      if (taskCard.classList.contains("completed")) {
        const taskDescriptionEl = taskCard.querySelector(".input-task-description");
        taskDescriptionEl.disabled = false;
        autoAdjustHeight(taskDescriptionEl);
        taskDescriptionEl.disabled = true;
      }
      toggleTaskDetails(taskCard);
    });
  });
};

export {
  loadTheme,
  toggleTheme,
  renderProjectViewButtons,
  clearProjectViewButtons,
  renderTaskViewButtons,
  clearTaskViewButtons,
  renderBreadcrumbNav,
  clearItemContainer,
  renderAllProjects,
  renderTasks,
  showTaskViewButtons,
  showTopOfPage,
  autoAdjustHeight,
  toggleTaskElements,
  clickHandlerCompletedTaskCard,
};
